#!/bin/sh
# KHr from: https://openwrt.org/faq/how_to_get_a_list_of_connected_clients
#
# This script is located under /usr/bin/clients
#
# Shows MAC, IP address and any hostname info for all connected wifi devices
# written for openwrt 12.09 Attitude Adjustment
#
# BusyBox /bin/sh (ash) compatible.
#

LOG="/var/log/clients.log"
LOG_MAX=500

info_log() {
  text=$1
  stamp=$(date)
  echo "$stamp: $text" >> "$LOG"
}

trim_log() {
  f=$1
  [ -f "$f" ] || return 0
  lines=$(wc -l < "$f" 2>/dev/null)
  [ -n "$lines" ] || return 0
  if [ "$lines" -gt "$LOG_MAX" ]; then
    tail -n "$LOG_MAX" "$f" > "$f.tmp" && mv "$f.tmp" "$f"
  fi
}

# Ensure log exists and limit size
if [ -f "$LOG" ]; then
  trim_log "$LOG"
else
  touch "$LOG"
  info_log "System startup"
fi

echo "Connected WIFI devices:"
printf "IP address\tname\tMAC address\n"

# list all wireless network interfaces
for interface in $(iwinfo 2>/dev/null | grep ESSID | cut -f 1 -s -d" "); do
  # get mac addresses of connected stations/clients
  maclist=$(iwinfo "$interface" assoclist 2>/dev/null | grep dBm | cut -f 1 -s -d" ")

  for mac in $maclist; do
    # Extract fields from dhcp leases (format: <expiry> <mac> <ip> <hostname> ...)
    ip=$(awk -v m="$(echo "$mac" | tr '[:upper:]' '[:lower:]')" '
      BEGIN{IGNORECASE=1}
      $2==m {print $3; exit}
    ' /tmp/dhcp.leases 2>/dev/null)

    host=$(awk -v m="$(echo "$mac" | tr '[:upper:]' '[:lower:]')" '
      BEGIN{IGNORECASE=1}
      $2==m {print $4; exit}
    ' /tmp/dhcp.leases 2>/dev/null)

    [ -z "$host" ] && host=""

    if [ -n "$ip" ]; then
      printf "%s\t%s\t%s\n" "$ip" "$host" "$mac"
      info_log "ip=$ip host=$host mac=$mac"
    fi
  done
done
